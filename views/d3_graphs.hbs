<script src="https://d3js.org/d3.v4.js"></script>

<html>
<head>
<!--Selects the month to get form dbk-->
  <title>making dropdowns</title>



</head>
<h2>
  Select a month to view commute data
</h2>
  <div class="center-content">
      <form action="/d3_graphs" method="get">
        <select name="month" id="month">
          <option value="" disabled selected>Select Month</option>
          <option value="1">January - 1</option>
          <option value="2">February - 2</option>
          <option value="3">March - 3</option>
          <option value="4">April - 4</option>
          <option value="5">May - 5</option>
          <option value="6">June - 6</option>
          <option value="7">July - 7</option>
          <option value="8">August - 8</option>
          <option value="9">September - 9</option>
          <option value="10">October - 10</option>
          <option value="11">November - 11</option>
          <option value="12">December - 12</option>
        </select>
        <button type="submit">Show Graphs</button>
      </form>
  </div>

<br/>

<!--options to filter by day of the week-->
<h2>
  Filter Graph by days of the week
</h2>
<div class="center-content">
  <div class="checkbox-container">
    <label><input type="checkbox" value="Monday" class="chkDay" checked>Monday</label><br>
    <label><input type="checkbox" value="Tuesday" class="chkDay" checked>Tuesday</label><br>
    <label><input type="checkbox" value="Wednesday" class="chkDay" checked>Wednesday</label><br>
    <label><input type="checkbox" value="Thursday" class="chkDay" checked>Thursday</label><br>
    <label><input type="checkbox" value="Friday" class="chkDay" checked>Friday</label><br>
    <label><input type="checkbox" value="Saturday" class="chkDay" checked>Saturday</label><br>
    <label><input type="checkbox" value="Sunday" class="chkDay" checked>Sunday</label><br>
  </div>
</div>



<hr>

<br/>

<h2>
  Draw vertical lines on the graph by time
</h2>
<!--button to draw user input lines -->
<input type="number" id="homeX1" placeholder="Draw Line 1">
<input type="number" id="homex2" placeholder="Draw Line 2">
<button id="drawLineButton">Draw Line</button>
<br/><br/><br/><br/>

<div><svg id="d3Legend" height="60" width="580"></svg></div>
<div class="center-content">
  <div id="toWorkViz"></div>
</div>
<div class="center-content">
<div id="toHomeViz"></div>
</div>

<hr>
<div id="heatmap"></div>

<hr>

<input type="number" id="trafficDay" placeholder="Day">
<input type="number" id="leaveTime" placeholder="Time to Leave Home">
<input type="number" id="altLeaveTime" placeholder="Alternative Time to Leave Home">
<input type="number" id="timeAtWork" placeholder="Time at Work">
<button id="calcDiffButton">Calculate Difference</button>

<!-- taking in data from the app.js -->
<input type="hidden" value={{{json data}}} id="commute-data"  />

</html>
  <!--script>
  // Get the hidden input element
  var hiddenInput = document.getElementById("commute-data");
  // Parse the JSON data from the hidden input's value
  var jsonData = JSON.parse(hiddenInput.value);
  // Now you can use the parsed jsonData object to inspect and work with the imported data
  console.log(jsonData); // Log the parsed JSON data to the console
  </script-->

<script>

const commuteData = JSON.parse(document.getElementById("commute-data").value);

const toWorkCal = [{'key': 1, 'density': [], 'day_of': ""},
                    {'key': 2, 'density': [], 'day_of': ""},
                    {'key': 3, 'density': [], 'day_of': ""},
                    {'key': 4, 'density': [], 'day_of': ""},
                    {'key': 5, 'density': [], 'day_of': ""},
                    {'key': 6, 'density': [], 'day_of': ""},
                    {'key': 7, 'density': [], 'day_of': ""},
                    {'key': 8, 'density': [], 'day_of': ""},
                    {'key': 9, 'density': [], 'day_of': ""},
                    {'key': 10, 'density': [], 'day_of': ""},
                    {'key': 11, 'density': [], 'day_of': ""},
                    {'key': 12, 'density': [], 'day_of': ""},
                    {'key': 13, 'density': [], 'day_of': ""},
                    {'key': 14, 'density': [], 'day_of': ""},
                    {'key': 15, 'density': [], 'day_of': ""},
                    {'key': 16, 'density': [], 'day_of': ""},
                    {'key': 17, 'density': [], 'day_of': ""},
                    {'key': 18, 'density': [], 'day_of': ""},
                    {'key': 19, 'density': [], 'day_of': ""},
                    {'key': 20, 'density': [], 'day_of': ""},
                    {'key': 21, 'density': [], 'day_of': ""},
                    {'key': 22, 'density': [], 'day_of': ""},
                    {'key': 23, 'density': [], 'day_of': ""},
                    {'key': 24, 'density': [], 'day_of': ""},
                    {'key': 25, 'density': [], 'day_of': ""},
                    {'key': 26, 'density': [], 'day_of': ""},
                    {'key': 27, 'density': [], 'day_of': ""},
                    {'key': 28, 'density': [], 'day_of': ""},
                    {'key': 29, 'density': [], 'day_of': ""},
                    {'key': 30, 'density': [], 'day_of': ""},
                    {'key': 31, 'density': [], 'day_of': ""},
                    ];

const toHomeCal = [{'key': 1, 'density': [], 'day_of': ""},
                    {'key': 2, 'density': [], 'day_of': ""},
                    {'key': 3, 'density': [], 'day_of': ""},
                    {'key': 4, 'density': [], 'day_of': ""},
                    {'key': 5, 'density': [], 'day_of': ""},
                    {'key': 6, 'density': [], 'day_of': ""},
                    {'key': 7, 'density': [], 'day_of': ""},
                    {'key': 8, 'density': [], 'day_of': ""},
                    {'key': 9, 'density': [], 'day_of': ""},
                    {'key': 10, 'density': [], 'day_of': ""},
                    {'key': 11, 'density': [], 'day_of': ""},
                    {'key': 12, 'density': [], 'day_of': ""},
                    {'key': 13, 'density': [], 'day_of': ""},
                    {'key': 14, 'density': [], 'day_of': ""},
                    {'key': 15, 'density': [], 'day_of': ""},
                    {'key': 16, 'density': [], 'day_of': ""},
                    {'key': 17, 'density': [], 'day_of': ""},
                    {'key': 18, 'density': [], 'day_of': ""},
                    {'key': 19, 'density': [], 'day_of': ""},
                    {'key': 20, 'density': [], 'day_of': ""},
                    {'key': 21, 'density': [], 'day_of': ""},
                    {'key': 22, 'density': [], 'day_of': ""},
                    {'key': 23, 'density': [], 'day_of': ""},
                    {'key': 24, 'density': [], 'day_of': ""},
                    {'key': 25, 'density': [], 'day_of': ""},
                    {'key': 26, 'density': [], 'day_of': ""},
                    {'key': 27, 'density': [], 'day_of': ""},
                    {'key': 28, 'density': [], 'day_of': ""},
                    {'key': 29, 'density': [], 'day_of': ""},
                    {'key': 30, 'density': [], 'day_of': ""},
                    {'key': 31, 'density': [], 'day_of': ""},
                    ];

console.log(commuteData);
//move data into toXxxxCal for graphing in D3
for (let i = 0; i < commuteData.length; i++){
  const dayString = commuteData[i]["commute_date"];
  const tempDate = new Date(dayString);
  const temp = tempDate.getUTCDate() - 1;


  /*
  commute time with no traffic can change depending on route taken, maps will sometimes route
  longer if there is a large obstruction, total diff will make it look small if so
  commuteData[i]["to_home"]/60 - commuteData[i]["to_home_no_traffic"]/60
  */
  /*
  const homeDiff = commuteData[i]["to_home"]/60 - commuteData[i]["to_home_no_traffic"]/60;
  var tempHomeArr = [commuteData[i]["ssm"]/3600,homeDiff];
  const workDiff = commuteData[i]["to_work"]/60 - commuteData[i]["to_work_no_traffic"]/60;
  var tempWorkArr = [commuteData[i]["ssm"]/3600,workDiff];
  */
  const homeDiff = commuteData[i]["to_home"]/60 - 16.05;
  var tempHomeArr = [commuteData[i]["ssm"]/3600,homeDiff];
  const workDiff = commuteData[i]["to_work"]/60 - 16.05;
  var tempWorkArr = [commuteData[i]["ssm"]/3600,workDiff];
  
  //when data is missing in the middle of the day, adds a 0 value to prevent weird interpolation on graph
  if (i < commuteData.length - 1) {
    if (commuteData[i]["ssm"] + 301 < commuteData[i + 1]["ssm"]) {
      tempWorkArr = [(commuteData[i + 1]["ssm"] - 1)/3600, 0];
      tempHomeArr = [(commuteData[i + 1]["ssm"] - 1)/3600, 0];
    } 
  }

  toHomeCal[temp]['density'].push(tempHomeArr);
  toHomeCal[temp]['day_of'] = commuteData[i]["day_of"];
  toWorkCal[temp]['density'].push(tempWorkArr);
  toWorkCal[temp]['day_of'] = commuteData[i]["day_of"];
};
  
//put a 0 point at the first datapoint on a line, otherwise graph filling can invert
for (let i = 0; i < toWorkCal.length || i < toHomeCal.length; i++) {
  if (i < toWorkCal.length && toWorkCal[i]['day_of'] !== "") {
    let flatline = [[toWorkCal[i]['density'][0][0] - 0.08333333333333333, 0]];
    toWorkCal[i]['density'] = flatline.concat(toWorkCal[i]['density']);
  }

  if (i < toHomeCal.length && toHomeCal[i]['day_of'] !== "") {
    let flatlineHome = [[toHomeCal[i]['density'][0][0] - 0.08333333333333333, 0]];
    toHomeCal[i]['density'] = flatlineHome.concat(toHomeCal[i]['density']);
  }
}

//0 value at the end to keep fill from going high
for (let i = 0; i < toWorkCal.length; i++) {
  //avoids filling in too much missing data
  if (toWorkCal[i]['density'].length > 100) { 
    toWorkCal[i]['density'].push([24, 0]);
    toHomeCal[i]['density'].push([24, 0]);
  }
}

console.log(toWorkCal);
</script>



<script>

// set the dimensions and margins of the graph
//original values {top: 60, right: 30, bottom: 20, left:110}
var margin = {top: 60, right: 25, bottom: 40, left:40},
    width = 600 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

// Get the different categories and count them
var categories = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]
var n = categories.length


var color_table = {
      "Monday": "#e41a1c",
      "Tuesday": "#ff7f00",
      "Wednesday": "#CCBBBB",
      "Thursday": "#4daf4a",
      "Friday": "#377eb8",
      "Saturday": "#710193",
      "Sunday": "#000000"
};

// append the svg object to the body of the page
var toWorksvg = d3.select("#toWorkViz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Add X axis
var x = d3.scaleLinear()
  .domain([0, 24])
  .range([ 0, width]);
toWorksvg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x));

// Create a Y scale for densities
var y = d3.scaleLinear()
  .domain([0, 100])///////////////17.5
  .range([ height, 0]);

// Create the Y axis for names
var yName = d3.scaleBand()
  .domain(categories)
  .range([0, height])
  .paddingInner(1)
toWorksvg.append("g")
  .call(d3.axisLeft(yName));

toWorksvg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "middle")
    .attr("x", width/2)
    .attr("y", height+35)
    .text("Time of day");

toWorksvg.append("text")
    .attr("text-anchor", "end")
    .attr("transform", "rotate(-90)")
    .attr("y", -margin.left+15)
    .attr("x", -margin.top*2)
    .text("Day")

toWorksvg.selectAll("areas")
  .data(toWorkCal)
  .enter()
  .append("path")
    .attr("transform", function(toWorkCal){
      return("translate(0," + (yName(toWorkCal.key)-height) +")" )})
    //.datum(function(cal){return(cal.density)})
    //.attr("fill", function(cal) {return color(cal); })
    .attr("fill", function(toWorkCal){
      grp = toWorkCal.day_of;
      return color_table[grp]
    })
    .datum(function(toWorkCal){return(toWorkCal.density)}) //data is transformed after this
    .attr("opacity", .8)
    .attr("stroke", "#000")
    .attr("stroke-width", 1)
    .attr("d",  d3.line()
        .curve(d3.curveBasis)
        .x(function(getX) { return x(getX[0]); })
        .y(function(getY) { return y(getY[1]); })
    );

toWorksvg.append("text")
        .attr("x", width/2)      
        .attr("y", -10 - (margin.top /2))
        .attr("text-anchor", "middle")  
        .style("font-size", "16px") 
        .style("text-decoration", "underline")  
        .text("Commute to Work");


function updateToWork(selectedDays) {
    toWorksvg.selectAll("path").remove(); // Clear existing paths

    toWorksvg.selectAll("areas")
      .data(toWorkCal.filter(item => selectedDays.includes("all") || selectedDays.includes(item.day_of)))
      .enter()
      .append("path")
        .attr("transform", function(toWorkCal) {
            return ("translate(0," + (yName(toWorkCal.key) - height) + ")");
        })
        .attr("fill", function(toWorkCal) {
            grp = toWorkCal.day_of;
            return color_table[grp];
        })
        .datum(function(toWorkCal) {
            return (toWorkCal.density);
        })
        .attr("opacity", .8)
        .attr("stroke", "#000")
        .attr("stroke-width", 1.3)
        .attr("d", d3.line()
            .curve(d3.curveBasis) //rounded option
            //.curve(d3.curveStepBefore) // square option
            .x(function(getX) { return x(getX[0]); })
            .y(function(getY) { return y(getY[1]); })
        );
}

///////////////////////////////
// graph for commuting to home
var toHomeSvg = d3.select("#toHomeViz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

toHomeSvg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x));


// Create the Y axis for names
toHomeSvg.append("g")
  .call(d3.axisLeft(yName));

toHomeSvg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "middle")
    .attr("x", width/2)
    .attr("y", height+35)
    .text("Time of day");

toHomeSvg.append("text")
    .attr("text-anchor", "end")
    .attr("transform", "rotate(-90)")
    .attr("y", -margin.left+15)
    .attr("x", -margin.top*2)
    .text("Day")





toHomeSvg.selectAll("areas")
  .data(toHomeCal)
  .enter()
  .append("path")
    .attr("transform", function(toHomeCal){return("translate(0," + (yName(toHomeCal.key)-height) +")" )})
    //.datum(function(cal){return(cal.density)})
    //.attr("fill", function(cal) {return color(cal); })
    .attr("fill", function(toHomeCal){
      grp = toHomeCal.day_of;
      return color_table[grp]
    })
    .datum(function(toHomeCal){return(toHomeCal.density)}) //data is transformed after this
    .attr("opacity", .8)
    .attr("stroke", "#000")
    .attr("stroke-width", 1.3)
    .attr("d",  d3.line()
        .curve(d3.curveBasis)
        .x(function(getX) { return x(getX[0]); })
        .y(function(getY) { return y(getY[1]); })
    );


toHomeSvg.append("text")
        .attr("x", width/2)      
        .attr("y", -10 - (margin.top /2))
        .attr("text-anchor", "middle")  
        .style("font-size", "16px") 
        .style("text-decoration", "underline")  
        .text("Commute to Home");



function updateToHome(selectedDays) {
    toHomeSvg.selectAll("path").remove(); // Clear existing paths

    toHomeSvg.selectAll("areas")
      .data(toHomeCal.filter(item => selectedDays.includes("all") || selectedDays.includes(item.day_of)))
      .enter()
      .append("path")
        .attr("transform", function(toHomeCal) {
            return ("translate(0," + (yName(toHomeCal.key) - height) + ")");
        })
        .attr("fill", function(toHomeCal) {
            grp = toHomeCal.day_of;
            return color_table[grp];
        })
        .datum(function(toHomeCal) {
            return (toHomeCal.density);
        })
        .attr("opacity", .8)
        .attr("stroke", "#000")
        .attr("stroke-width", 1.3)
        .attr("d", d3.line()
            .curve(d3.curveBasis)
            .x(function(getX) { return x(getX[0]); })
            .y(function(getY) { return y(getY[1]); })
        );
}


/* Update graph when multiSelect option changes
d3.select("#multiSelect").on("change", function() {
    const selectedDays = Array.from(this.selectedOptions, option => option.value);
    if (selectedDays.length === 0) {
        selectedDays.push("all"); // Default to "All Days" if nothing selected
    }
    updateToHome(selectedDays);
    updateToWork(selectedDays);
});
*/
d3.selectAll(".chkDay").on("change", function() {
    const selectedDays = d3.selectAll(".chkDay:checked").nodes().map(node => node.value);
    updateToHome(selectedDays);
    updateToWork(selectedDays);
});




var x1Input = document.getElementById("homeX1");
var x2Input = document.getElementById("homex2");
var drawLineButton = document.getElementById("drawLineButton");

// Add an event listener to the button
drawLineButton.addEventListener("click", function() {
    // Get user input values for x1 and x2
    var userX1 = +x1Input.value; // Convert to number
    var userX2 = +x2Input.value; // Convert to number

    // Remove any existing lines
    toWorksvg.selectAll("line").remove();
    toHomeSvg.selectAll("line").remove();

    // Draw the new line based on user input
    toWorksvg.append("line")
        .attr("x1", x(userX1))
        .attr("y1", 0)
        .attr("x2", x(userX1))
        .attr("y2", height)
        .style("stroke-width", 1.5)
        .style("stroke", "black")
        .style("fill", "none");

    toHomeSvg.append("line")
        .attr("x1", x(userX1))
        .attr("y1", 0)
        .attr("x2", x(userX1))
        .attr("y2", height)
        .style("stroke-width", 1.5)
        .style("stroke", "black")
        .style("fill", "none");

    toWorksvg.append("line")
        .attr("x1", x(userX2))
        .attr("y1", 0)
        .attr("x2", x(userX2))
        .attr("y2", height)
        .style("stroke-width", 1.5)
        .style("stroke", "black")
        .style("fill", "none");

    toHomeSvg.append("line")
        .attr("x1", x(userX2))
        .attr("y1", 0)
        .attr("x2", x(userX2))
        .attr("y2", height)
        .style("stroke-width", 1.5)
        .style("stroke", "black")
        .style("fill", "none");
});




//attemping gradiant color
//  .attr("fill", "#69b3a2")
//const dayColors = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
const dayColors = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
const color = d3.scaleOrdinal()
  .domain(dayColors)
  .range(['#e41a1c','#ff7f00','#CCBBBB','#4daf4a','#377eb8','#710193','#000000'])

//d3 legend for ridgeline plot
const legendSvg = d3.select("#d3Legend")
const size = 15
legendSvg.selectAll("mydots")
  .data(dayColors)
  .enter()
  .append("rect")
    .attr("x", function(d,i){ return 40 + 80 * i})
    .attr("y", 10)
    .attr("width", size)
    .attr("height", size)
    .style("fill", function(d){ return color(d)})

legendSvg.selectAll("mylabels")
  .data(dayColors)
  .enter()
  .append("text")
    .attr("y", 40)
    .attr("x", function(d,i){ return 20 + 80 * i})
    .style("fill", function(d){ return color(d)})
    .text(function(d){ return d})
    .attr("text-anchor", "right")
    .style("alignment-baseline", "middle")



var dayInput = document.getElementById("trafficDay")
var leaveTimeInput = document.getElementById("leaveTime")
var timeAtWorkInput = document.getElementById("timeAtWork")
var altLeaveInput = document.getElementById("altLeaveTime")
var calcButton = document.getElementById("calcDiffButton")

RENAMETHSI.addEventListener('click', () => {
  const key = parseInt(dayInput.value);
  const dayEntry = toWorkCal.find(item => item.key === key);

  if (dayEntry) {
    const toWorkComm = dayEntry.density[leaveTimeInput * 12][1];
    const toHomeComm = dayEntry.density[(leaveTimeInput+timeAtWorkInput) * 12][1];

    const toWorkCommAlt = dayEntry.density[(leaveTimeInput+altLeaveInput) * 12][1];
    const toHomeComm2Alt = dayEntry.density[(leaveTimeInput+altLeaveInput+timeAtWorkInput) * 12][1];


    densityResult.textContent = `Density at index 0 for ${dayEntry.day_of}: ${densityAtIndex0}`;
  } else {
    densityResult.textContent = 'No information found for the provided key.';
  }
});


const tDay = document.getElementById("trafficDay");
const lTime = document.getElementById("leaveTime");
const altTime = document.getElementById("altLeaveTime");
const tWork = document.getElementById("timeAtWork");


/*const calcButton = document.getElementById('calcButton');
const keyInput = document.getElementById('keyInput');
const densityResult = document.getElementById('densityResult');

calcButton.addEventListener('click', () => {
  const key = parseInt(keyInput.value);
  const dayEntry = toWorkCal.find(item => item.key === key);

  if (dayEntry) {
    const densityAtIndex0 = dayEntry.density[0];
    densityResult.textContent = `Density at index 0 for ${dayEntry.day_of}: ${densityAtIndex0}`;
  } else {
    densityResult.textContent = 'No information found for the provided key.';
  }
});
*/

</script>